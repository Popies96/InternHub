<div class="flex h-screen bg-gray-100">

  <!-- User List -->
  <div class="w-full md:w-96 p-4 overflow-y-auto">
    <div class="backdrop-blur-lg bg-white/70 rounded-2xl shadow-xl border border-white/20 p-6 h-full">
      <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 mr-2 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
        Conversations
      </h2>
      
      <!-- Search Bar -->
      
      <div class="flex flex-col gap-1.5">
        <div *ngFor="let user of users"
             [id]="user.id"
             (click)="selectUser(user)"
             class="flex items-center cursor-pointer p-3 rounded-xl hover:bg-white/80 transition-all duration-300 group"
             [class.bg-white]="user === selectedUser"
             [class.shadow-md]="user === selectedUser"
             [class.border-indigo-200]="user === selectedUser"
             [class.border]="user === selectedUser">

          <!-- Avatar with Status Indicator -->
          <div class="relative">
            <div class="w-12 h-12 rounded-xl overflow-hidden shadow-sm group-hover:shadow-md transition-all">
              <img [src]="'https://placehold.co/200x/ffa8e4/ffffff.svg?text=' + user?.nom?.charAt(0)"
              alt="Selected User Avatar"
              class="w-10 h-10 rounded-full mr-4 shadow-sm">
            </div>
            <!-- Online Status -->
            <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-400 rounded-full border-2 border-white"></span>
            <!-- Unread Indicator -->
            <span *ngIf="unseenMessages[user.id]" 
                  class="absolute -top-1 -right-1 flex items-center justify-center w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full animate-bounce">
            </span>
          </div>

          <!-- User Info -->
          <div class="ml-4 flex-1 min-w-0">
            <div class="flex justify-between items-center">
              <h3 class="text-sm font-semibold text-gray-800 truncate">{{ user.nom }} {{ user.prenom }}</h3>
              <span class="text-xs text-gray-400">
                <ng-container *ngIf="lastMessages[user.id] as lastMsg">
                  {{ lastMsg.timestamp | date:'shortTime' }}
                </ng-container>
              </span>
            </div>
            <p class="text-xs text-gray-500 truncate mt-1">
              <ng-container *ngIf="lastMessages[user.id] as lastMsg; else noMsg">
                <strong *ngIf="lastMsg.senderId == currentUser" class="text-indigo-600">You: </strong>
                <span>{{ (lastMsg.content | slice:0:30) + (lastMsg.content.length > 30 ? '...' : '') }}</span>
                <span *ngIf="lastMsg.audioUrl" class="inline-flex items-center text-indigo-500">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                  </svg>
                </span>
              </ng-container>
              <ng-template #noMsg>Start a conversation</ng-template>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Area -->
  <div class="flex-1 flex flex-col h-full bg-gray-50" *ngIf="selectedUser">

    <!-- Chat Header -->
    <div class="bg-white p-4 border-b border-gray-300 shadow-sm">
      <div class="flex items-center">
        <img [src]="'https://placehold.co/200x/ffa8e4/ffffff.svg?text=' + selectedUser?.prenom?.charAt(0)"
             alt="Selected User Avatar"
             class="w-10 h-10 rounded-full mr-4 shadow-sm">
        <div>
          <h2 class="text-lg font-semibold text-gray-800">{{ selectedUser.nom }} {{ selectedUser.prenom }}</h2>
          <p class="text-xs text-green-500">Online</p>
        </div>
      </div>
    </div>

    <!-- Chat Messages -->
    <div class="chat-area flex-1 overflow-y-auto p-4 space-y-4">
      <div *ngFor="let message of messages">

        <!-- Sent Text Message -->
        <div *ngIf="+message.senderId === +currentUser && message.content"
             class="flex justify-end">
          <div class="bg-blue-600 text-white rounded-2xl px-4 py-2 max-w-xs shadow-md">
            <p class="text-sm">{{ message.content }}</p>
            <small class="text-xs text-gray-200 opacity-80 mt-1 block text-right">{{ message.timestamp | date:'shortTime' }}</small>
          </div>
        </div>

        <!-- Sent Audio Message -->
        <div *ngIf="+message.senderId === +currentUser && message.audioUrl" class="flex justify-end">
          <div class="bg-blue-600 text-white rounded-2xl px-4 py-2 max-w-xs shadow-md">
            <div class="flex items-center">
              <button (click)="playAudioMessage(message)" class="mr-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                </svg>
              </button>
              <span>Audio message</span>
            </div>
            <small class="text-xs text-gray-200 opacity-80 mt-1 block text-right">
              {{ message.timestamp | date:'shortTime' }}
            </small>
          </div>
        </div>
      
        <!-- Audio Message - Received -->
        <div *ngIf="+message.senderId === +selectedUser?.id && message.audioUrl" class="flex justify-start">
          <div class="bg-white text-gray-900 rounded-2xl px-4 py-2 max-w-xs shadow-md border border-gray-200">
            <div class="flex items-center">
              <button (click)="playAudioMessage(message)" class="mr-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                </svg>
              </button>
              <span>Audio message</span>
            </div>
            <small class="text-xs text-gray-400 mt-1 block text-right">
              {{ message.timestamp | date:'shortTime' }}
            </small>
          </div>
        </div>
      

        <!-- Received Text Message -->
        <div *ngIf="+message.senderId === +selectedUser?.id && message.content"
             class="flex justify-start">
          <div class="bg-white text-gray-900 rounded-2xl px-4 py-2 max-w-xs shadow-md border border-gray-200">
            <p class="text-sm">{{ message.content }}</p>
            <small class="text-xs text-gray-400 mt-1 block text-right">{{ message.timestamp | date:'shortTime' }}</small>
          </div>
        </div>

        <!-- Received Audio Message -->
        <div *ngIf="+message.senderId === +selectedUser?.id && message.audioUrl"
             class="flex justify-start">
       
        </div>

      </div>
    </div>

    <div class="bg-white border-t border-gray-200 p-4">
      <!-- Recording Indicator -->
      <div *ngIf="isRecording" class="mb-3 flex items-center justify-between bg-red-50 rounded-lg p-2 border border-red-100">
        <div class="flex items-center">
          <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse mr-2"></span>
          <span class="text-sm font-medium text-red-700">Recording...</span>
        </div>
        <button (click)="stopRecording()" class="text-xs text-red-700 hover:text-red-900 font-medium">
          Stop
        </button>
      </div>
      
      <div class="relative">
        <input [(ngModel)]="newMessage"
               type="text"
               (keydown.enter)="sendMessage()"
               placeholder="Type a message..."
               class="w-full pl-4 pr-12 py-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm shadow-sm transition-all">
        
        <!-- Send/Record Button -->
        <div class="absolute right-1 top-1/2 transform -translate-y-1/2 flex items-center space-x-1">
          <!-- Emoji Picker -->
      <!-- Emoji Picker Button -->
<button (click)="toggleEmojiPicker()" class="p-2 text-gray-500 hover:text-blue-600 rounded-full transition duration-300 ease-in-out hover:bg-gray-100">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
  </svg>
</button>

<!-- Emoji Picker Dropdown -->
<div *ngIf="isEmojiPickerVisible" class="absolute bottom-16 right-10 bg-white border border-gray-200 rounded-lg shadow-lg p-2 w-60 max-h-60 overflow-y-auto z-50 transform scale-95 transition-all duration-300 ease-in-out">
  <div class="grid grid-cols-6 gap-2">
    <!-- Emoji Buttons -->
    <button *ngFor="let emoji of emojis" (click)="addEmoji(emoji)" class="text-lg hover:bg-gray-200 p-1 rounded-full transition duration-200">
      {{ emoji }}
    </button>
  </div>
</div>

          <!-- Toggle Record/Send Button -->
          <button (click)="isRecording ? stopRecording() : startRecording()"
                  *ngIf="!newMessage.trim()"
                  class="p-1.5 text-white rounded-full transition"
                  [class.bg-red-500]="isRecording"
                  [class.bg-gray-400]="!isRecording"
                  [class.hover:bg-red-600]="isRecording"
                  [class.hover:bg-gray-500]="!isRecording">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path *ngIf="!isRecording" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
              <path *ngIf="isRecording" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              <path *ngIf="isRecording" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
            </svg>
          </button>
          
          <!-- Send Button (when text exists) -->
          <button (click)="sendMessage()"
                  *ngIf="newMessage.trim()"
                  class="p-1.5 text-white bg-blue-500 rounded-full hover:bg-blue-600 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
          </button>
        </div>
      </div>
    </div>

  </div>

  <!-- Empty State -->
  <div *ngIf="!selectedUser" class="flex-1 flex items-center justify-center bg-gray-50">
    <div class="text-center p-8">
      <div class="mx-auto w-24 h-24 bg-gray-200 rounded-full flex items-center justify-center mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
      </div>
      <h3 class="text-lg font-medium text-gray-900 mb-1">No conversation selected</h3>
      <p class="text-sm text-gray-500">Select a chat from the sidebar to start messaging</p>
    </div>
  </div>

</div>