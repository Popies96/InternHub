<div class="fixed bottom-4 right-4 z-50 w-[380px] max-w-full" *ngIf="visible">
  <div class="bg-white border border-gray-300 rounded-lg shadow-lg"
       style="height: 65vh; display: flex; flex-direction: column;">
   
    <!-- HEADER -->
    <div class="flex items-center py-3 px-4 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-t-lg">
      <img [src]="'https://placehold.co/200x/ffa8e4/ffffff.svg?text=' + selectedUser?.nom?.charAt(0)"
      alt="Selected User Avatar"
      class="w-10 h-10 rounded-full mr-3 shadow-sm border-2 border-white/30">     
      <span class="text-md font-semibold text-white">{{ selectedUser?.nom || 'Support' }}</span>
      <button class="ml-auto text-white text-xl font-bold hover:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center transition" (click)="close()">Ã—</button>
    </div>

    <!-- CHAT MESSAGES -->
    <div class="chat-area flex-1 overflow-y-auto p-4 space-y-4">
      <div *ngFor="let message of messages">

        <!-- Sent Text Message -->
        <div *ngIf="+message.senderId === +currentUser && message.content"
             class="flex justify-end">
          <div class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-2xl px-4 py-2 max-w-xs shadow-md">
            <p class="text-sm">{{ message.content }}</p>
            <small class="text-xs text-blue-100 opacity-90 mt-1 block text-right">
              {{ message.timestamp | date:'shortTime' }}
              <svg *ngIf="message.seen" xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
              </svg>
            </small>
          </div>
        </div>

        <!-- Sent Audio Message -->
        <div *ngIf="+message.senderId === +currentUser && message.audioUrl" class="flex justify-end">
          <div class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-2xl px-4 py-2 max-w-xs shadow-md">
            <div class="flex items-center">
              <button (click)="playAudioMessage(message)" class="p-1.5 bg-white/20 rounded-full hover:bg-white/30 transition mr-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                </svg>
              </button>
              <div class="flex-1">
                <div class="h-2 bg-white/30 rounded-full overflow-hidden">
                  <div class="h-full bg-white/80 rounded-full" style="width: 70%"></div>
                </div>
              
              </div>
            </div>
          </div>
        </div>
     
        <!-- Received Audio Message -->
        <div *ngIf="+message.senderId === +selectedUser?.id && message.audioUrl" class="flex justify-start">
          <div class="bg-white text-gray-900 rounded-2xl px-4 py-2 max-w-xs shadow-md border border-gray-200">
            <div class="flex items-center">
              <button (click)="playAudioMessage(message)" class="p-1.5 bg-gray-100 rounded-full hover:bg-gray-200 transition mr-2"> 
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                </svg>
              </button>
              <div class="flex-1">
                <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div class="h-full bg-indigo-500 rounded-full" style="width: 70%"></div>
                </div>
                
              </div>
            </div>
          </div>
        </div>

        <!-- Received Text Message -->
        <div *ngIf="+message.senderId === +selectedUser?.id && message.content"
             class="flex justify-start">
          <div class="bg-white text-gray-900 rounded-2xl px-4 py-2 max-w-xs shadow-md border border-gray-200">
            <p class="text-sm">{{ message.content }}</p>
            <small class="text-xs text-gray-500 mt-1 block text-right">{{ message.timestamp | date:'shortTime' }}</small>
          </div>
        </div>
      </div>
    </div>

    <!-- INPUT -->
    <div class="bg-white border-t border-gray-200 p-4">
      <!-- Recording Indicator -->
      <div *ngIf="isRecording" class="mb-3 flex items-center justify-between bg-red-50 rounded-lg p-2 border border-red-100">
        <div class="flex items-center">
          <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse mr-2"></span>
          <span class="text-sm font-medium text-red-700">Recording...</span>
        </div>
        <button (click)="stopRecording()" class="text-xs text-red-700 hover:text-red-900 font-medium">
          Stop
        </button>
      </div>
      
      <div class="relative">
        <input [(ngModel)]="newMessage"
               type="text"
               (keydown.enter)="sendMessage()"
               placeholder="Type a message..."
               class="w-full pl-4 pr-12 py-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm shadow-sm transition-all">
        
        <!-- Send/Record Button -->
        <div class="absolute right-1 top-1/2 transform -translate-y-1/2 flex items-center space-x-1">
          <!-- Emoji Picker -->
       <!-- Emoji Picker Button -->
<button (click)="toggleEmojiPicker()" class="p-2 text-gray-500 hover:text-blue-600 rounded-full transition duration-300 ease-in-out hover:bg-gray-100">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
  </svg>
</button>

<!-- Emoji Picker Dropdown -->
<div *ngIf="isEmojiPickerVisible" class="absolute bottom-16 right-10 bg-white border border-gray-200 rounded-lg shadow-lg p-2 w-60 max-h-60 overflow-y-auto z-50 transform scale-95 transition-all duration-300 ease-in-out">
  <div class="grid grid-cols-6 gap-2">
    <!-- Emoji Buttons -->
    <button *ngFor="let emoji of emojis" (click)="addEmoji(emoji)" class="text-lg hover:bg-gray-200 p-1 rounded-full transition duration-200">
      {{ emoji }}
    </button>
  </div>
</div>

          
          <!-- Toggle Record/Send Button -->
          <button (click)="isRecording ? stopRecording() : startRecording()"
                  *ngIf="!newMessage.trim()"
                  class="p-1.5 text-white rounded-full transition"
                  [class.bg-red-500]="isRecording"
                  [class.bg-gray-400]="!isRecording"
                  [class.hover:bg-red-600]="isRecording"
                  [class.hover:bg-gray-500]="!isRecording">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path *ngIf="!isRecording" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
              <path *ngIf="isRecording" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              <path *ngIf="isRecording" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
            </svg>
          </button>
          
          <!-- Send Button (when text exists) -->
          <button (click)="sendMessage()"
                  *ngIf="newMessage.trim()"
                  class="p-1.5 text-white bg-blue-500 rounded-full hover:bg-blue-600 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>